import"./modulepreload-polyfill-3cfb730f.js";function d(i){let e="=".repeat((4-i.length%4)%4),t=(i+e).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(t),r=new Uint8Array(n.length);for(let s=0,a=n.length;s<a;++s)r[s]=n.charCodeAt(s);return r}function l({title:i,useNative:e}){if(e){let t=new Notification(i,{tag:"normal",icon:"/app/img/favicon.ico",body:"native!"});t.addEventListener("click",function(n){console.log(n)}),setTimeout(t.close.bind(t),3e3)}else navigator.serviceWorker.ready.then(t=>{t.showNotification(i,{icon:"/app/img/favicon.ico",body:"can u see?"})})}function o(i){let e=document.createElement("p");e.textContent=i,document.querySelector("#infos").appendChild(e)}function c(i,e,t){return fetch(i,{method:e,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then(n=>{if(n.ok)return n.text()})}const u="http://47.93.35.239/net_set",p="BKmzm3addDa0_hQNkJ0Readn9V2-mIhtdNvfq_yOzYpY14hGhSGJ5ZD4flqSCBDEwlwxjiaLHparbg2n0h0gxOU";class h{constructor({elAddTo:e}){this.dfdPrompt=null,this.elAddTo=e}initSW(){"serviceWorker"in navigator?(navigator.serviceWorker.register("/sw.js",{scope:"/"}).then(e=>{o(`ServiceWorker登记成功，范围为${e.scope}`)}).catch(function(e){o("ServiceWorker登记失败："),o(e)}),navigator.serviceWorker.addEventListener("message",e=>{o(`msg received from sw : ${e.data}`)})):alert("not support serviceWorker")}initPush(){"PushManager"in window?navigator.serviceWorker.ready.then(e=>{e.pushManager.getSubscription().then(t=>{t?o("already subscribed!!!"):(o("begin subscribe..."),this.subscribe(e))})}):alert("not support PushManager")}cancelPush(){return new Promise((e,t)=>{navigator.serviceWorker.ready.then(n=>{n.pushManager.getSubscription().then(r=>{r?r.unsubscribe().then(s=>{o("cancel subscribe success"),e()}).catch(s=>{o("cancel subscribe fail"),o(s),t(s)}):e()})})})}initNotification(){Notification.requestPermission().then(e=>{e==="granted"?o("Notification is supported"):alert("not support Notification")})}initAddToScreen(){let e=document.querySelector(this.elAddTo);window.addEventListener("beforeinstallprompt",n=>{n.userChoice.then(r=>t(r,n))}),e.addEventListener("click",()=>{this.dfdPrompt!=null&&(this.dfdPrompt.prompt(),this.dfdPrompt.userChoice.then(n=>t(n)))});function t(n,r){n.outcome==="dismissed"?(o("用户取消安装应用"),!this.dfdPrompt&&r&&(this.dfdPrompt=r),e.style.display="block"):(o("用户安装了应用"),this.dfdPrompt=null,e.style.display="none")}}subscribe(e){e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:d(p)}).then(t=>(o("browser subscribe success, send subscription to server"),c(u,"post",{endpoint:t.endpoint,p256dh:t.toJSON().keys.p256dh,auth:t.toJSON().keys.auth}))).catch(t=>{o("browser subscribe fail"),o(t),console.warn(t),Notification.permission==="denied"&&o("用户拒绝了订阅请求")})}}function f(){let i=document.querySelector(".t-notification"),e=document.querySelector(".t-api"),t=document.querySelector(".t-api-no");i.addEventListener("click",n=>{l({title:"test...",useNative:!0})}),e.addEventListener("click",n=>{c("/api_report","POST",{type:0,code:1,content:"tte"}).then(r=>console.log(r))}),t.addEventListener("click",n=>{c("/list","POST",{type:0}).then(r=>console.log(r))})}function b(i){document.querySelector(".re-subscribe").addEventListener("click",t=>{i.cancelPush().then(()=>{i.initPush()})})}console.log({BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1});window.addEventListener("load",()=>{m(),f()});function m(){let i=new h({elAddTo:"#btn-add"});i.initSW(),i.initPush(),i.initNotification(),i.initAddToScreen(),b(i)}
